<?php
/**
 * @var \Zend\View\Renderer\PhpRenderer    $this
 * @var \Application\ResultSet\Translation $translations
 * @var \Application\ResultSet\Suggestion  $suggestions
 * @var \Application\ResultSet\Locale      $supportedLocales
 * @var \Application\Model\TranslationBase $baseTranslation
 * @var \Application\Model\Translation     $translation
 * @var \Application\Model\Locale          $locale
 * @var string $currentLocale
 * @var string $currentTranslationFile
 * @var array $messages of strings
 * @var int $previousItemId
 * @var int $nextItemId
 */
?>

<?php if (isset($messages) && count($messages)): ?>
    <ul class="messages row">
        <?php foreach ($messages as $messageLevel => $messageLevelContainer): ?>
            <?php foreach ($messageLevelContainer as $message): ?>
                <li class="alert alert-<?= $this->escapeHtmlAttr($messageLevel); ?>" role="alert">
                    <?= $this->escapeHtml($message); ?>
                </li>
            <?php endforeach; ?>
        <?php endforeach; ?>
    </ul>
<?php endif; ?>

<div class="row">
    <div class="col-12">
        <div class="card mt-4">
            <div class="card-header">
                <strong><?= $this->translate('Filter') ?></strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <b><?= $this->translate('Selected file:') ?></b> <span class="label label-primary"><?= $this->escapeHtml($currentTranslationFile) ?></span>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupLocaleSelect"><?= $this->translate('Language') ?></label>
                            </div>
                            <select class="custom-select" id="inputGroupLocaleSelect">
                                <?php foreach ($supportedLocales as $locale): ?>
                                    <option value="<?= $locale->getLocale() ?>"<?php if ($currentLocale === $locale->getLocale()): ?> selected="selected"<?php endif; ?>><?= $this->translate($locale->getLocale()) ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form action="" method="post">
    <div class="row">
        <div class="col-12">
            <?php $rowName         = 'row' . $currentLocale; ?>
            <?php $unclearSelected = $translations[$currentLocale]->getUnclear() ?>

            <input type="hidden" name="base_id" value="<?= $baseTranslation->getId() ?>">
            <input type="hidden" name="<?= $rowName ?>_locale" value="<?= $this->escapeHtmlAttr($currentLocale) ?>">
            <input type="hidden" name="<?= $rowName ?>_id" value="<?= $translations[$currentLocale]->getId() ?>">

            <div class="card mt-4">
                <div class="card-header">
                    <strong>
                        <?= $this->translate('Translation') ?>
                        <span class="pull-right">&nbsp;<img src="<?= $this->basePath('img/flags/' . strtolower(substr($currentLocale, 3, 2))) ?>.png" alt="<?= $currentLocale ?>" />&nbsp;</span>
                        <?php if ($unclearSelected): ?>
                            <span class="fa fa-exclamation-triangle pull-right text-warning" style="margin-top: 6px;" title="<?= $this->translate('Unclear translation') ?>">&nbsp;</span>
                        <?php endif; ?>
                    </strong>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label><?= $this->translate('Origin source') ?></label>
                        <input type="text" class="form-control" readonly placeholder="<?= $this->escapeHtml($baseTranslation->getOriginSource()); ?>">
                    </div>

                    <div class="form-group">
                        <label for="translationInput"><?= $this->translate('Current translation') ?></label>
                        <input id="translationInput" type="text" class="form-control" autofocus="true" value="<?= $translations[$currentLocale]->getTranslation(); ?>">
                    </div>

                    <div class="form-check">
                        <?php $unclearSelected = $translations[$currentLocale]->getUnclear() ?>
                        <input type="checkbox" class="form-check-input" name="<?= $rowName ?>_unclearTranslation" id="<?= $rowName ?>_unclearTranslation" value="1" <?php if ($unclearSelected) echo 'checked="checked"' ?>>
                        <label class="form-check-label" for="<?= $rowName ?>_unclearTranslation"><?= $this->translate('Translation is unclear') ?></label>
                        <small class="form-text text-muted">
                            <?= $this->translate('String is usually marked as unclear if translation should be reviewed by another person.') ?>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 mt-4">
            <button type="submit" value="all" name="rowid" class="btn btn-primary pull-right" id="save-all-button"><?= $this->translate('Save') ?></button>
        </div>
    </div>

<?php /*
    <div class="row">
        <div class="col-md-12">
            <div class="card mt-4">
                <div class="card-header">
                    <strong>Existing suggestions</strong>
                    <span class="badge badge-info pull-right"><?= $currentLocale ?></span>
                    <span class="pull-right">&nbsp;<img src="<?= $this->basePath('img/flags/' . strtolower(substr($currentLocale, 0, 2))) ?>.png" alt="<?= $currentLocale ?>" />&nbsp;</span>
                </div>
                <div class="card-body suggestionlist">
                    <?php foreach ($suggestions as $suggestion): ?>
                        <span class="badge badge-info" id="suggestion_<?= $suggestion->getSuggestionId() ?>">
                            <?= $suggestion->getSuggestedTranslation() ?>
                        </span>
                    <?php endforeach; ?>

                    <?php //echo $this->escapeHtml($translations[$currentLocale]->getTranslation()); ?>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="card mt-4">
                <div class="card-header">
                    <strong>Submit a new suggestion</strong>
                    <span class="badge badge-info pull-right"><?= $currentLocale ?></span>
                    <span class="pull-right">&nbsp;<img src="<?= $this->basePath('img/flags/' . strtolower(substr($currentLocale, 0, 2))) ?>.png" alt="<?= $currentLocale ?>" />&nbsp;</span>
                </div>
                <div class="card-body">
                    <div class="input-group col-md-12">
                        <textarea class="form-control" rows="3" name="<?= $rowName ?>_suggestedTranslation"></textarea>
                    </div>
                    <button type="submit" value="<?= $rowName ?>" name="rowid" class="btn btn-primary">Submit suggestion</button>
                </div>
            </div>
        </div>
    </div>
*/ ?>
    <div class="row">
        <div class="col-md-12 mt-4">
            <div style="margin-bottom: 25px; overflow: hidden;">
                <a class="btn btn-info pull-left" href="<?= $this->url('index', [ 'action' => 'edit', 'base_id' => $previousItemId ], [ 'query' => [ 'locale' => $currentLocale ] ]) ?>">Previous translation</a>
                <a class="btn btn-info pull-right" href="<?= $this->url('index', [ 'action' => 'edit', 'base_id' => $nextItemId ], [ 'query' => [ 'locale' => $currentLocale ] ]) ?>">Next translation</a>
            </div>
        </div>
    </div>

<?php /*
    <div class="row">
        <div class="col-md-12">
            <div class="card mt-4" role="tablist" aria-multiselectable="true" data-toggle="collapse" data-target="#MageVersions">
                <div class="card-header">
                    <strong>Further translations (MageVersions)</strong>
                </div>
                <div class="card-body collapse" id="MageVersions">
                    <table class="table table-hover table-striped" id="translation-grid">
                        <tr>
                            <th>MageVersion<th>
                            <th>Current translation<th>
                            <th colspan="2" class="text-center"><span title="unclear translation">Status</span></th>
                            <th>t.b.d.<th>
                            <th><th>
                        </tr>
                        <?php foreach ($translations as $locale => $translation): ?>
                            <?php if ($locale == $currentLocale) continue; ?>
                            <?php ?>
                            <?php $rowName = 'row' . $locale; ?>
                            <tr id="<?= $rowName ?>">
                                <td><?= $this->escapeHtml($locale) ?><td>
                                <td><?= $this->escapeHtml($translation->getTranslation()) ?><td>
                                <td>
                                    <?php if ($translation->getUnclear()): ?>
                                        <i class="fa fa-exclamation-triangle unclear" title="unclear translation"></i>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <input type="radio" name="<?= $rowName?>_unclearTranslation" value="1" <?= ($translation->getUnclear()) ? 'checked="checked"':'' ?>>
                                    <!-- <input type="checkbox" name="<?= $rowName?>_unclearTranslation" value="1" <?= ($translation->getUnclear()) ? 'checked="checked"':'' ?>> -->
                                </td>
                                <td class="suggested-translation">
                                    <input type="text" class="form-control" name="<?= $rowName?>_suggestedTranslation" value="" />
                                <td>
                                <td>
                                    <div style="min-width: 125px">
                                        <input type="hidden" name="<?= $rowName ?>_locale" value="<?= $locale ?>" />
                                        <input type="hidden" name="<?= $rowName?>_id" value="<?= $this->escapeHtmlAttr($translation->getId())?>" />
                                        <button type="submit" value="<?= $rowName?>" name="rowid" class="btn btn-primary" data-toggle="tooltip" data-placement="right" title="Submit Suggestion"><span class="fa fa-plus"></span></button>
                                        &nbsp;
                                        <a class="btn btn-info" data-toggle="tooltip" data-placement="right" title="See Details" href="<?= $this->url('index', [ 'action' => 'edit', 'base_id' => $baseTranslation->getId() ], [ 'query' => [ 'locale' => $locale ] ]) ?>"><span class="fa fa-search"></span></a>
                                    </div>
                                <td>
                            </tr>
                        <?php endforeach; ?>
                    </table>
                </div>
            </div>
        </div>
    </div>
*/ ?>

    <div class="row">
        <div class="col-md-12">
                <div class="card mt-4" role="tablist" aria-multiselectable="true" data-target="#locales">
                <div class="card-header">
                    <strong>Further translations (locales)</strong>
                </div>
                <div class="card-body" id="locales">
                    <table class="table table-hover table-striped" id="translation-grid">
                        <tr>
                            <th>Locale<th>
                            <th>Current translation<th>
                            <th colspan="2" class="text-center"><span title="unclear translation">Status</span></th>
                            <th>Add Suggestion<th>
                            <th width="10%"><th>
                        </tr>
                        <?php foreach ($translations as $locale => $translation): ?>
                            <?php if ($locale === $currentLocale) continue; ?>
                            <?php $rowName = 'row' . $locale; ?>
                            <tr id="<?= $rowName ?>">
                                <td>
                                    <img src="<?= $this->basePath('img/flags/' . strtolower(substr($locale, 3, 2))) ?>.png" alt="">
                                    <?= $this->escapeHtml($locale) ?>
                                <td>
                                <td>
                                    <?= $this->escapeHtml($translation->getTranslation()) ?>
                                <td>
                                <td>
                                    <?php if ($translation->getUnclear()): ?>
                                        <i class="fa fa-exclamation-triangle text-warning unclear" title="unclear translation"></i>
                                    <?php endif; ?>
                                </td>
                                <td>
                                    <input type="radio" name="<?= $rowName?>_unclearTranslation" value="1" <?= ($translation->getUnclear()) ? 'checked="checked"':'' ?>>
                                </td>
                                <td class="suggested-translation">
                                    <input type="text" class="form-control" name="<?= $rowName?>_suggestedTranslation" value="" />
                                <td>
                                <td class="text-right">
                                    <input type="hidden" name="<?= $rowName ?>_locale" value="<?= $locale ?>" />
                                    <input type="hidden" name="<?= $rowName?>_id" value="<?= $this->escapeHtmlAttr($translation->getId())?>" />
                                    <button type="submit" value="<?= $rowName?>" name="rowid" class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="right" title="Submit Suggestion"><span class="fa fa-plus"></span></button>
                                    <a class="btn btn-info btn-sm" data-toggle="tooltip" data-placement="right" title="See Details" href="<?= $this->url('index', [ 'action' => 'edit', 'base_id' => $baseTranslation->getId() ], [ 'query' => [ 'locale' => $locale ] ]) ?>"><span class="fa fa-search"></span></a>
                                <td>
                            </tr>
                        <?php endforeach; ?>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <button type="submit" value="all" name="rowid" class="btn btn-primary pull-right" id="save-all-button">Submit all</button>
        </div>
    </div>
</form>

<?php $this->inlineScript()->captureStart(); ?>

$("document").ready(function () {
    $('#inputGroupLocaleSelect').change(function () {
        var url = "<?= $this->url('index', [ 'action' => 'edit', 'base_id' => $baseTranslation->getId() ]); ?>?";

        url += "locale=" + $('#inputGroupLocaleSelect').val() + "&";

        window.location.href = url;
    });
});

<?php $this->inlineScript()->captureEnd(); ?>
